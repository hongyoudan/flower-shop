webpackJsonp([21],{J04f:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=r("Wxq9"),s={name:"MallPurchase",components:{MallFooter:r("loKF").a},data:function(){return{isVip:null,buyId:null,totalPrice:0,productSpec:null,options:o.regionData,username:"",discountStrength:98,addressForm:{selectedOptions:[],detailAddress:""},addressRules:{selectedOptions:[{validator:function(t,e,r){null===e||0===e.length?r(new Error("请选择收货地址")):r()},trigger:"blur"}],detailAddress:[{validator:function(t,e,r){null===e||0===e.trim().length?r(new Error("请填写详细地址")):r()},trigger:"blur"}]},addressFormVisible:!1,orderFormVisible:!1,productInfo:{productName:"",outPrice:"",productDescribe:"",productUrl:""},order:{orderNo:"",productNo:"",userAccount:"",userName:"",contactWay:"",payPrice:"",discountPrice:"",productSpecs:null,payAmount:1,payType:"",orderFrom:"",orderState:"",returnState:!1,acceptAddress:""},shoppingCart:{accountNumber:"",productId:null,payAmount:1,productSpecs:null},orderRules:{userName:[{validator:function(t,e,r){null===e||0===e.trim().length?r(new Error("请填写收货人")):r()},trigger:"blur"}],contactWay:[{validator:function(t,e,r){null===e||0===e.trim().length?r(new Error("请填写联系方式")):/^((0\d{2,3}-\d{7,8})|(1[3584]\d{9}))$/.test(e)?r():r(new Error("请填写正确的手机号"))},trigger:"blur"}],acceptAddress:[{validator:function(t,e,r){null===e||0===e.trim().length?r(new Error("请填写收货地址")):r()},trigger:"blur"}]}}},methods:{handleChange:function(t){},submitForm:function(t){var e=this;this.$refs[t].validate(function(t){if(!t)return!1;for(var r="",s=e.addressForm.selectedOptions,i=0,a=s.length;i<a;i++)r+=o.CodeToText[s[i]]+" ";r+="("+e.addressForm.detailAddress+")",e.order.acceptAddress=r,e.addressFormVisible=!1})},buy:function(){var t=this;this.getDateNow(),this.order.productNo=this.productInfo.productNo,this.order.userAccount=this.$store.state.user.accountNumber,null!==this.order.userName&&0===this.order.userName.length&&(this.order.userName=this.$store.state.user.userName),this.order.payPrice=this.totalPrice,this.order.payType="支付宝",this.order.orderFrom="网页商城",this.order.orderState="待付款",this.order.returnState=!1,this.isVip&&(this.discountStrength=9.8,this.order.payPrice>=1e3&&this.order.payPrice<5e3?this.discountStrength=9.5:this.order.payPrice>=5e3&&(this.discountStrength=9),this.order.discountPrice=Math.floor(this.order.payPrice*this.discountStrength/10)),null!==this.order.contactWay&&0===this.order.contactWay.length?null===this.$store.state.user.telephone||0===this.$store.state.user.telephone.length?this.$confirm("检测到您未绑定手机号，快递小哥哥将无法找到您","提示",{confirmButtonText:"现在绑定",cancelButtonText:"临时填写",type:"warning"}).then(function(){t.$router.push("/personalCenter")}).catch(function(){t.orderFormVisible=!0}):(this.order.contactWay=this.$store.state.user.telephone,this.orderFormVisible=!0):this.orderFormVisible=!0},createOrder:function(t){var e=this;this.$refs[t].validate(function(t){if(!t)return!1;e.isVip&&(e.order.payPrice=e.order.discountPrice);var r=e.$loading({lock:!0,text:"订单提交中",background:"rgba(255,255,255,0.1)"});e.$http.post("/order/add",e.$qs.stringify(e.order,{skipNulls:!0})).then(function(t){if(r.close(),200===t.data.code){var o=e.order.orderNo,s="花卷商城-"+e.productInfo.productType+"-"+e.productInfo.productName+"支付订单",i=e.order.payPrice,a=e.$loading({lock:!0,text:"正在跳转支付页面",background:"rgba(255,255,255,0.1)"});e.$http.post("/alipay/create?orderNo="+o+"&orderName="+s+"&payPrice="+i).then(function(t){a.close();var e=document.createElement("div");e.innerHTML=t.data,document.body.appendChild(e),document.forms[document.forms.length-1].submit()}).catch(function(t){a.close(),e.$msg.error(t)})}}).catch(function(t){r.close(),e.$msg.error(t)}),e.orderFormVisible=!1})},toReview:function(){this.$router.push({path:"/productReview",query:{keyword:this.productInfo.productNo}})},calculationPrice:function(){this.totalPrice=(this.order.payAmount*this.productInfo.outPrice).toFixed(2)},joinCart:function(){var t=this;this.$confirm("将商品放入到购物车中","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){t.shoppingCart.productId=t.buyId,t.shoppingCart.productSpecs=t.order.productSpecs,t.shoppingCart.payAmount=t.order.payAmount;var e=t.$loading({lock:!0,text:"数据提交中",background:"rgba(255,255,255,0.1)"});t.$http.post("/shoppingCart/add",t.$qs.stringify(t.shoppingCart)).then(function(r){e.close(),200===r.data.code&&t.$message({type:"success",message:"成功加入购物车!"})}).catch(function(r){e.close(),t.$msg.error(r)})}).catch(function(){})},getDateNow:function(){var t=new Date,e=String(t.getFullYear());e=e.substring(2);var r=String(t.getMonth()+1),o=String(t.getDate()),s=String(t.getHours());s.length<2&&(s="0"+s);var i=String(t.getSeconds());i.length<2&&(i="0"+i);var a=Math.floor(9e3*Math.random()+1e3+1);this.order.orderNo=e+r+o+s+i+a}},created:function(){var t=this;if(this.$store.state.user&&(this.isVip=this.$store.state.user.isVip,this.order.acceptAddress=this.$store.state.user.userAddress,this.shoppingCart.accountNumber=this.$store.state.user.accountNumber),this.buyId=this.$route.query.id,null!=this.buyId){var e=this.$loading({lock:!0,text:"数据加载中",background:"rgba(255,255,255,0.2)"});this.$http.post("/product/findById?productId="+this.buyId).then(function(r){e.close(),200===r.data.code?(t.productInfo=r.data.data,t.totalPrice=t.productInfo.outPrice.toFixed(2)):t.$msg.error(r.data.message)}).catch(function(e){t.$msg.error(e)}),this.$http.post("/productSpecs/findAllByProId?productId="+this.buyId).then(function(e){200===e.data.code?(t.productSpec=e.data.data,t.order.productSpecs=t.productSpec[0]):t.$msg.error(e.data.message)}).catch(function(e){t.$msg.error(e)})}}},i={render:function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"mall-purchase"},[r("div",{staticClass:"product-box"},[r("div",{staticClass:"nav-bar"},[t.productInfo?r("div",{staticClass:"container"},[r("el-image",{staticClass:"logo",staticStyle:{width:"65px",height:"65px","margin-top":"10px","margin-right":"15px"},attrs:{src:t.productInfo.productUrl}}),t._v(" "),r("div",{staticStyle:{display:"inline-block",position:"absolute",top:"35px"}},[r("span",{staticStyle:{"font-size":"19px","font-weight":"bolder"}},[t._v(t._s(t.productInfo.productName))]),t._v(" "),r("el-divider",{attrs:{direction:"vertical"}}),t._v(" "),r("span",{staticStyle:{"font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.productInfo.productType))])],1),t._v(" "),r("el-link",{attrs:{type:"danger"},on:{click:t.toReview}},[t._v("商品评价")])],1):t._e()])]),t._v(" "),r("div",{staticClass:"product-info"},[r("div",{staticClass:"product-info-content container"},[r("div",{staticClass:"img"},[r("el-image",{staticStyle:{height:"85%",width:"70%",margin:"15%"},attrs:{src:t.productInfo.productUrl}})],1),t._v(" "),r("div",{staticClass:"product-con"},[r("h2",[t._v(t._s(t.productInfo.productName))]),t._v(" "),r("p",{staticClass:"sale-desc"},[t._v(t._s(t.productInfo.productDescribe))]),t._v(" "),r("div",{staticClass:"price-info"},[r("span",[t._v(t._s(t.productInfo.outPrice)+" 元")])]),t._v(" "),r("div",{staticClass:"line"}),t._v(" "),r("div",{staticClass:"address-box container"},[r("i",{staticClass:"el-icon-location-outline"}),t._v(" "),r("div",{staticClass:"address-con"},[t.order.acceptAddress?r("div",{staticClass:"address-info"},[t._v(t._s(t.order.acceptAddress))]):r("div",{staticClass:"address-info"},[t._v("未设置")])]),t._v(" "),r("div",{staticClass:"address-alter",on:{click:function(e){t.addressFormVisible=!0}}},[t._v("修改")])]),t._v(" "),null!==this.productSpec&&0!==this.productSpec.length?r("div",{staticClass:"option-box"},[r("div",{staticClass:"title"},[t._v("选择规格")]),t._v(" "),t._l(this.productSpec,function(e,o){return r("el-radio-group",{key:o,staticClass:"option-list",attrs:{fill:"#ff6700"},model:{value:t.order.productSpecs,callback:function(e){t.$set(t.order,"productSpecs",e)},expression:"order.productSpecs"}},[r("el-radio-button",{attrs:{label:e}})],1)})],2):t._e(),t._v(" "),r("div",{staticClass:"select-amount"},[r("div",{staticStyle:{"font-size":"18px"}},[t._v("选择数量")]),t._v(" "),r("el-input-number",{staticStyle:{margin:"16px"},attrs:{min:1,max:t.productInfo.productStock},on:{change:t.calculationPrice},model:{value:t.order.payAmount,callback:function(e){t.$set(t.order,"payAmount",e)},expression:"order.payAmount"}})],1),t._v(" "),r("div",{staticClass:"selected-list container"},[r("span",[t._v(t._s(t.productInfo.productName))]),t._v(" "),r("span",{staticStyle:{"padding-left":"10px"}},[t._v(t._s(t.order.productSpecs))]),t._v(" "),r("span",{staticStyle:{"padding-left":"10px"}},[t._v(t._s(t.productInfo.outPrice)+"元")]),t._v(" "),r("div",[r("div",{staticClass:"total-price",model:{value:t.totalPrice,callback:function(e){t.totalPrice=e},expression:"totalPrice"}},[t._v("总计："+t._s(t.totalPrice)+"元")]),t._v(" "),r("el-button",{staticStyle:{float:"left",margin:"20px 40px"},attrs:{type:"success",plain:""},on:{click:t.joinCart}},[t._v("加入购物车")]),t._v(" "),r("el-button",{staticStyle:{float:"left",margin:"20px 0"},attrs:{type:"danger",plain:""},on:{click:t.buy}},[t._v("立即购买")])],1)])])])]),t._v(" "),r("el-dialog",{staticClass:"address-dialog",attrs:{title:"收货地址",width:"450px",visible:t.addressFormVisible},on:{"update:visible":function(e){t.addressFormVisible=e}}},[r("el-form",{ref:"addressForm",attrs:{model:t.addressForm,rules:t.addressRules}},[r("el-form-item",{attrs:{label:"所在地区",prop:"selectedOptions"}},[r("el-cascader",{attrs:{size:"large",options:t.options,separator:" "},on:{change:t.handleChange},model:{value:t.addressForm.selectedOptions,callback:function(e){t.$set(t.addressForm,"selectedOptions",e)},expression:"addressForm.selectedOptions"}})],1),t._v(" "),r("el-form-item",{attrs:{label:"详细地址",prop:"detailAddress"}},[r("el-input",{staticStyle:{width:"auto"},attrs:{autocomplete:"off"},model:{value:t.addressForm.detailAddress,callback:function(e){t.$set(t.addressForm,"detailAddress",e)},expression:"addressForm.detailAddress"}},[r("i",{staticClass:"el-icon-edit el-input__icon",attrs:{slot:"suffix"},slot:"suffix"})])],1)],1),t._v(" "),r("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[r("el-button",{on:{click:function(e){t.addressFormVisible=!1}}},[t._v("取 消")]),t._v(" "),r("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitForm("addressForm")}}},[t._v("确 定")])],1)],1),t._v(" "),r("el-dialog",{attrs:{title:"订单信息",visible:t.orderFormVisible,width:"600px"},on:{"update:visible":function(e){t.orderFormVisible=e}}},[r("el-form",{ref:"order",staticClass:"order-form",attrs:{model:t.order,rules:t.orderRules}},[r("el-form-item",{attrs:{label:"商品名称"}},[r("el-input",{attrs:{disabled:""},model:{value:this.productInfo.productName,callback:function(e){t.$set(this.productInfo,"productName",e)},expression:"this.productInfo['productName']"}})],1),t._v(" "),t.order.productSpecs?r("el-form-item",{attrs:{label:"商品规格"}},[r("el-input",{attrs:{disabled:""},model:{value:t.order.productSpecs,callback:function(e){t.$set(t.order,"productSpecs",e)},expression:"order.productSpecs"}})],1):t._e(),t._v(" "),r("el-form-item",{attrs:{label:"购买数量"}},[r("el-input",{attrs:{disabled:""},model:{value:t.order.payAmount,callback:function(e){t.$set(t.order,"payAmount",e)},expression:"order.payAmount"}})],1),t._v(" "),r("el-form-item",{attrs:{label:"支付金额"}},[t.isVip?r("el-input",{staticClass:"delete-line",attrs:{disabled:""},model:{value:t.order.payPrice,callback:function(e){t.$set(t.order,"payPrice",e)},expression:"order.payPrice"}}):r("el-input",{attrs:{disabled:""},model:{value:t.order.payPrice,callback:function(e){t.$set(t.order,"payPrice",e)},expression:"order.payPrice"}})],1),t._v(" "),t.isVip?r("el-form-item",{staticStyle:{position:"relative"},attrs:{label:"会员折扣"}},[r("el-input",{staticClass:"discount-price",attrs:{disabled:""},model:{value:t.order.discountPrice,callback:function(e){t.$set(t.order,"discountPrice",e)},expression:"order.discountPrice"}}),t._v(" "),r("el-button",{staticClass:"vip-info",attrs:{plain:""}},[t._v("花卷VIP "+t._s(t.discountStrength)+"折")])],1):t._e(),t._v(" "),r("el-form-item",{attrs:{label:"收货人",prop:"userName"}},[r("el-input",{attrs:{autocomplete:"off"},model:{value:t.order.userName,callback:function(e){t.$set(t.order,"userName",e)},expression:"order.userName"}})],1),t._v(" "),r("el-form-item",{attrs:{label:"联系方式",prop:"contactWay"}},[r("el-input",{attrs:{autocomplete:"off"},model:{value:t.order.contactWay,callback:function(e){t.$set(t.order,"contactWay",e)},expression:"order.contactWay"}})],1),t._v(" "),r("el-form-item",{staticStyle:{position:"relative"},attrs:{label:"收货地址",prop:"acceptAddress"}},[r("el-input",{attrs:{readonly:""},model:{value:t.order.acceptAddress,callback:function(e){t.$set(t.order,"acceptAddress",e)},expression:"order.acceptAddress"}}),t._v(" "),r("el-button",{staticStyle:{position:"absolute",top:"1px",right:"14px",border:"none"},attrs:{plain:""},on:{click:function(e){t.addressFormVisible=!0}}},[t._v("修改")])],1)],1),t._v(" "),r("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[r("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.createOrder("order")}}},[t._v("付 款")]),t._v(" "),r("el-button",{on:{click:function(e){t.orderFormVisible=!1}}},[t._v("取 消")])],1)],1),t._v(" "),r("MallFooter")],1)},staticRenderFns:[]};var a=r("VU/8")(s,i,!1,function(t){r("u3fX")},null,null);e.default=a.exports},u3fX:function(t,e){}});
//# sourceMappingURL=21.73efee6ab7527f8d389a.js.map